<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>编辑文章</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://unpkg.com/@wangeditor/editor@latest/dist/css/style.css" rel="stylesheet">
    <style>
        body { background-color: #f7f8fa; padding-bottom: 50px; }
        .main-container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
        .publish-card { background: #fff; border-radius: 12px; padding: 20px; border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .title-input { border: none; border-bottom: 1px solid #eee; padding: 15px 0; font-size: 1.25rem; font-weight: bold; width: 100%; outline: none; }
        #editor-content { min-height: 400px; }
        #editor-content img { max-width: 80%; border-radius: 8px; margin: 10px 0; display: block; }
        @media(max-width:768px){ #editor-content img{max-width:100%;} }
        .btn-save { width: 100%; padding: 10px; font-weight: bold; margin-top: 20px; }
    </style>
</head>
<body>

<div class="main-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0 fw-bold">编辑文章</h4>
        <a href="/admin" class="btn btn-light btn-sm rounded-pill px-3">返回管理</a>
    </div>

    <form method="POST" id="editForm">
        <div class="publish-card">
            <div class="mb-3">
                <input type="text" name="title" class="title-input" value="{{ article['title'] }}" required>
            </div>

            <div style="border: 1px solid #eee; border-radius: 8px; overflow: hidden;">
                <div id="editor-toolbar" style="border-bottom: 1px solid #eee; background: #fafafa;"></div>
                <div id="editor-content"></div> 
            </div>
            <textarea name="content" id="hiddenContent" style="display:none;"></textarea>

            <div class="mt-3">
                <label class="form-label fw-bold text-muted small">发布位置</label>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="publish_mode" id="modeNormal" value="normal" {% if article['is_top'] == 0 %}checked{% endif %}>
                    <label class="btn btn-outline-primary" for="modeNormal">普通列表</label>

                    <input type="radio" class="btn-check" name="publish_mode" id="modeTop" value="top" {% if article['is_top'] == 1 %}checked{% endif %}>
                    <label class="btn btn-outline-danger" for="modeTop">置顶推荐</label>
                </div>
            </div>

            <button type="submit" class="btn btn-primary btn-save" id="submitBtn">保存修改</button>
        </div>
    </form>
</div>

<!-- 用于数据回显的隐藏区域 -->
<div id="original-content" style="display: none;">{{ content | safe }}</div>

<script src="https://unpkg.com/@wangeditor/editor@latest/dist/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const { createEditor, createToolbar } = window.wangEditor;

    // 图片压缩逻辑 (同之前)
    function compressImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    const maxSize = 1500;
                    if (w > h && w > maxSize) { h *= maxSize/w; w = maxSize; }
                    else if (h > w && h > maxSize) { w *= maxSize/h; h = maxSize; }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.6));
                };
            };
        });
    }

    const editorConfig = {
        placeholder: '编辑内容...',
        onChange(editor) { document.getElementById('hiddenContent').value = editor.getHtml(); },
        MENU_CONF: {
            'uploadImage': {
                customUpload: async function (file, insertFn) {
                    try {
                        const base64 = await compressImage(file);
                        insertFn(base64);
                    } catch (e) { alert("图片处理失败"); }
                }
            }
        }
    };

    const editor = createEditor({
        selector: '#editor-content',
        config: editorConfig,
        mode: 'simple',
        html: document.getElementById('original-content').innerHTML // 关键：加载旧内容
    });

    const toolbar = createToolbar({
        editor,
        selector: '#editor-toolbar',
        config: { toolbarKeys: ['headerSelect', 'bold', 'color', '|', 'uploadImage', 'bulletedList', 'clearStyle'] },
        mode: 'simple'
    });
    
    // 初始化时同步一次
    document.getElementById('hiddenContent').value = editor.getHtml();

    document.getElementById('editForm').onsubmit = function() {
        const btn = document.getElementById('submitBtn');
        btn.innerHTML = '正在保存...';
        btn.disabled = true;
        document.getElementById('hiddenContent').value = editor.getHtml();
        return true;
    };
</script>
</body>
</html>