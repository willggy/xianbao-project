<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘å¸ƒçº¿æŠ¥</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://unpkg.com/@wangeditor/editor@latest/dist/css/style.css" rel="stylesheet">
    
    <style>
        :root { --ios-blue: #007aff; --bg-color: #f7f8fa; }
        body { background-color: var(--bg-color); font-family: -apple-system, sans-serif; padding-bottom: 50px; }
        .main-container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
        .publish-card { background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.04); padding: 20px; border: none; }
        .title-input { border: none; border-bottom: 1px solid #eee; border-radius: 0; padding: 15px 0; font-size: 1.25rem; font-weight: bold; box-shadow: none !important; }
        .title-input:focus { border-bottom-color: var(--ios-blue); }
        .editor-box { border: 1px solid #eee; border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
        #editor-toolbar { border-bottom: 1px solid #f1f1f1; background-color: #fafafa; }
        #editor-content { min-height: 350px; }
        
        /* é™åˆ¶å›¾ç‰‡æ˜¾ç¤ºå¤§å°ï¼Œé˜²æ­¢æ’‘çˆ†å±å¹• */
        #editor-content img { max-width: 80%; max-height: 400px; border-radius: 8px; margin: 10px 0; display: block; border: 1px solid #f0f0f0; }
        @media (max-width: 768px) { #editor-content img { max-width: 100%; } }

        .select-btn { border-radius: 10px; padding: 12px; font-weight: 600; border: 1px solid #eee; color: #555; width: 100%; transition: 0.2s; }
        .btn-check:checked + .btn-outline-primary { background-color: #eaf2ff; color: #007aff; border-color: #007aff; }
        .btn-check:checked + .btn-outline-danger { background-color: #fff0f0; color: #dc3545; border-color: #dc3545; }
        
        .btn-publish { background-color: var(--ios-blue); border: none; padding: 12px; font-weight: 600; border-radius: 8px; width: 100%; margin-top: 20px; font-size: 1.1rem; }
        .btn-publish:hover { background-color: #0066d6; }
        .toast-custom { position: fixed; top: 20px; right: 20px; z-index: 9999; }
    </style>
</head>
<body>

<div class="main-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0 fw-bold">å‘å¸ƒæ–°çº¿æŠ¥</h4>
        <a href="/" class="btn btn-light btn-sm rounded-pill px-3">è¿”å›</a>
    </div>

    <form action="/publish" method="POST" id="publishForm">
        <div class="publish-card">
            <div class="mb-3">
                <input type="text" name="title" class="form-control title-input" placeholder="è¯·è¾“å…¥æ ‡é¢˜..." required>
            </div>

            <div class="editor-box">
                <div id="editor-toolbar"></div>
                <div id="editor-content"></div> 
            </div>
            <textarea name="content" id="hiddenContent" style="display:none;"></textarea>

            <label class="form-label fw-bold text-muted small mb-2">å‘å¸ƒé€‰é¡¹</label>
            <div class="row g-3">
                <div class="col-6">
                    <input type="radio" class="btn-check" name="publish_mode" id="modeNormal" value="normal" checked>
                    <label class="btn select-btn btn-outline-primary" for="modeNormal">ğŸ‘ ç¾Šæ¯›ç²¾é€‰</label>
                </div>
                <div class="col-6">
                    <input type="radio" class="btn-check" name="publish_mode" id="modeTop" value="top">
                    <label class="btn select-btn btn-outline-danger" for="modeTop">ğŸ”¥ é¦–é¡µç½®é¡¶</label>
                </div>
            </div>

            <button type="submit" class="btn btn-primary btn-publish" id="submitBtn">ç«‹å³å‘å¸ƒ</button>
        </div>
    </form>
</div>

<!-- æç¤ºæ¡† -->
<div class="toast-container toast-custom">
    <div id="imgToast" class="toast align-items-center text-white bg-primary border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">æ­£åœ¨å¤„ç†å›¾ç‰‡...</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/@wangeditor/editor@latest/dist/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const { createEditor, createToolbar } = window.wangEditor;
    const toastEl = document.getElementById('imgToast');
    const toastBody = toastEl.querySelector('.toast-body');
    const toast = new bootstrap.Toast(toastEl);

    // === å›¾ç‰‡å‹ç¼©åŠŸèƒ½ï¼šæ ¸å¿ƒä»£ç  ===
    function compressImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    // é™åˆ¶æœ€å¤§å®½é«˜ä¸º 1500pxï¼Œä¿æŒæ¯”ä¾‹
                    let w = img.width, h = img.height;
                    const maxSize = 1500;
                    if (w > h && w > maxSize) { h *= maxSize/w; w = maxSize; }
                    else if (h > w && h > maxSize) { w *= maxSize/h; h = maxSize; }
                    
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    
                    // å‹ç¼©ä¸º JPEGï¼Œè´¨é‡ 0.6 (ä½“ç§¯å¤§å¹…å‡å°)
                    resolve(canvas.toDataURL('image/jpeg', 0.6));
                };
            };
        });
    }

    // ç¼–è¾‘å™¨é…ç½®
    const editorConfig = {
        placeholder: 'åœ¨æ­¤è¾“å…¥å†…å®¹ï¼Œæˆªå›¾ç›´æ¥ç²˜è´´ (ä¼šè‡ªåŠ¨å‹ç¼©)...',
        onChange(editor) { document.getElementById('hiddenContent').value = editor.getHtml(); },
        MENU_CONF: {
            // æ¥ç®¡å›¾ç‰‡ä¸Šä¼ é€»è¾‘
            'uploadImage': {
                customUpload: async function (file, insertFn) {
                    toastEl.className = "toast align-items-center text-white bg-primary border-0 shadow";
                    toastBody.innerText = "ğŸ”„ æ­£åœ¨å‹ç¼©å›¾ç‰‡...";
                    toast.show();
                    try {
                        const base64 = await compressImage(file);
                        insertFn(base64); // æ’å…¥å‹ç¼©åçš„å›¾ç‰‡
                        toastEl.className = "toast align-items-center text-white bg-success border-0 shadow";
                        toastBody.innerText = "âœ… å›¾ç‰‡å‹ç¼©æˆåŠŸï¼";
                    } catch (e) {
                        alert("å›¾ç‰‡å¤„ç†å¤±è´¥");
                    }
                }
            }
        }
    };

    const editor = createEditor({
        selector: '#editor-content', config: editorConfig, mode: 'simple'
    });
    const toolbar = createToolbar({
        editor, selector: '#editor-toolbar',
        config: { toolbarKeys: ['headerSelect', 'bold', 'color', '|', 'uploadImage', 'bulletedList', 'clearStyle'] },
        mode: 'simple'
    });

    // æäº¤æ ¡éªŒ
    document.getElementById('publishForm').onsubmit = function() {
        const content = editor.getHtml();
        if (content === '<p><br></p>' || content.trim() === '') { alert('å†…å®¹ä¸èƒ½ä¸ºç©º'); return false; }
        const btn = document.getElementById('submitBtn');
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> æ­£åœ¨ä¸Šä¼ ...';
        btn.disabled = true;
        document.getElementById('hiddenContent').value = content;
        return true;
    };
</script>
</body>
</html>